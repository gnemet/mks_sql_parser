version: "1.0.0040"
last_build: "2026-01-05 11:54 CET"
rules:
  - id: 1
    description: "Block Logic: Defines the start and end of conditional or iterative blocks. Matches standard block starts: --<tag, --<!tag (negated), or --<tag:subtag"
    regex: '--<(!?)([\w]+)(?:(:|!:)([^>\s]+))?'
    action: block_start

  - id: 2
    description: "Matches JSONPath block starts: --<{ $.path.to.key }"
    regex: '--\s*<\{\s*(.*?)\s*\}'
    action: block_start_jsonpath

  - id: 3
    description: "Matches block ends: --> or --tag> or -->tag"
    regex: '^\s*--(?:[\w!:]+>|>(?:[\w!:]*))\s*$'
    action: block_end

  - id: 4
    description: "Matches nested block starts using Postgres array syntax: --< $1 #> '{key1,key2}' = 'value' >"
    regex: '--\s*<\s*\$1\s*#>\s*[$>^&@#]*\s*''{([^'']+)}''(?:\s*=\s*''([^'']+)'')?\s*>'
    action: block_start_nested

  - id: 5
    description: "Matches simple conditional block starts: --< #key = 'value' > or --< #key != 'value' > or other ops"
    regex: '--\s*<\s*#''?([^\s'']+)''?\s*(!~~\*|!~\*|!~~|~~\*|!%>|!=|!~|~\*|~~|!%|%>|=|~|%)\s*''([^'']+)''\s*>'
    action: block_start_simple_extended

  - id: 6
    description: "Line Filter Tags: Matches JSONPath line filters: --#{ $.path.to.key }"
    regex: '--\s*#\{\s*(.*?)\s*\}'
    action: line_filter_jsonpath

  - id: 7
    description: "Matches simple conditional line filters: --#key = 'value' or other ops"
    regex: '--\s*#''?([^\s'']+)''?\s*(!~~\*|!~\*|!~~|~~\*|!%>|!=|!~|~\*|~~|!%|%>|=|~|%)\s*''([^'']+)'''
    action: line_filter_simple_extended

  - id: 8
    description: "Matches standard line filters: #tag, #!tag, #tag:subtag, #!tag:val, #tag:!val"
    regex: '#(!?)([\w]+)(?:(:|!:)([^>\s]+))?'
    action: line_filter

  - id: 9
    description: "Postgres Filter: Checks for key existence using various JSON operators. Matches: $1->'key', $1#>>'key', etc."
    regex: '\$1\s*(?:->>|->|#>>|#>|#=|#\^|#@|->&|#&|->\^|->@|->>>|#>>>|->&&|#&&|#>=#|#<=#|#<>#|->##|#>##|->\^\^|->@@|#\^\^|#@@|->#)\s*''([^'']+)'''
    action: delete

  - id: 10
    description: "Nested Keys: Matches Postgres Array Syntax for nested line filtering. Matches: $1 #> '{path,to,key}' = 'value'"
    regex: '\$1\s*#>\s*[$>^&@#]*\s*''{([^'']+)}''(?:\s*=\s*''([^'']+)'')?'
    action: line_filter_nested

  - id: 11
    description: "Replace or Delete: Handles standard SQL parameters and legacy $ prefixes. Matches: :variable_name or $variable_name"
    regex: '\B[\$:]([a-zA-Z_]\w*)'
    action: replace_delete

  - id: 12
    description: "Replace or Empty: Handles bracketed placeholder syntax. Matches: %variable_name%"
    regex: '%(\w+)%'
    action: replace_empty

test:
  # Test ID 1: Block Logic
  - id: 1
    subid: 1
    description: "Block Exists: Keep block if key exists."
    input: { "key": true }
    text: |
      --<key
      KEPT by exists
      --key>      
      --<!key
      KEPT by not exists
      --key>      
      --<key:true
      KEPT by value is true
      --key>      
      --<!key:true
      KEPT by value is not false
      --key>
    expected: |
      KEPT by exists
      KEPT by value is true
    passed: true

  - id: 1
    subid: 2
    description: "Block Not Exists: Delete block if key exists."
    input: { "key": true }
    text: |
      --<!key
      DELETED
      --key>
    expected: ""
    passed: true

  - id: 1
    subid: 3
    description: "Block Value: Keep block if key=value."
    input: { "key": "val" }
    text: |
      --<key:val
      KEPT
      --key>
    expected: |
      KEPT
    passed: true

  - id: 1
    subid: 4
    description: "Block Not Value: Delete block if key=value."

    input: { "key": "val" }
    text: |
      --<!key:val
      DELETED
      --key>
    expected: ""
    passed: true

  - id: 1
    subid: 5
    description: "Block Not Value (Strict): Keep block if key!=value."
    input: { "key": "val" }
    text: |
      --<key!:other
      KEPT
      --key>
      --<key!:val
      DELETED
      --key>
    expected: |
      KEPT
    passed: true

  # Test ID 8: Line Filter Logic
  - id: 8
    subid: 1
    description: "Line Exists: Keep line if key exists."
    input: { "key": true }
    text: "SELECT 1 --#key"
    expected: "SELECT 1 --#key"
    passed: true
  - id: 8
    subid: 2
    description: "Line Not Exists: Delete line if key exists."
    input: { "key": true }
    text: "SELECT 1 --#!key"
    expected: ""
    passed: true
  - id: 8
    subid: 3
    description: "Line Value: Keep line if key=value."
    input: { "key": "val" }
    text: "SELECT 1 --#key:val"
    expected: "SELECT 1 --#key:val"
    passed: true
  - id: 8
    subid: 4
    description: "Line Not Value: Delete line if key=value."
    input: { "key": "val" }
    text: "SELECT 1 --#!key:val"
    expected: ""
    passed: true
  - id: 8
    subid: 5
    description: "Line Not Value (Alt): Delete line if key=value."
    input: { "key": "val" }
    text: "SELECT 1 --#key:!val"
    expected: ""
    passed: true

  # Test ID 9: Postgres Filters
  - id: 9
    subid: 1
    description: "Postgres Filters: Keep if key exists, delete if missing."
    input: { "key": 1 }
    text: |
      SELECT $1->'key'
      SELECT $1#>>'{key}'
      SELECT $1->'missing'
    expected: |
      SELECT $1->'key'
      SELECT $1#>>'{key}'
    passed: true
  # Test ID 11: Replace or Delete Logic
  - id: 11
    subid: 1
    description: "Replace or Delete: $var and :var replaced if exists, deleted if missing."
    input: { "var": "val" }
    text: |
      SELECT $var
      SELECT :var
      SELECT $missing
    expected: |
      SELECT val
      SELECT val
    passed: true

  - id: 12
    subid: 1
    description: "Replace or Empty/Delete: replace the %tag% or :tag or $tag if variable exists, otherwise replace the %tag% to empty string the other tags are line deleted"
    input: { "key1": "val" }
    text: |
      SELECT 'dummy'
        , concat( 'aaa', '%key1%' )
        , concat( 'aaa', ':key1' ) 
        , concat( 'aaa', '$key1' ) 
      SELECT 'dummy'
        , concat( 'aaa', '%key2%' )
        , concat( 'aaa', ':key2' ) 
        , concat( 'aaa', '$key2' )
    expected: |
      SELECT 'dummy'
        , concat( 'aaa', 'val' )
        , concat( 'aaa', 'val' ) 
        , concat( 'aaa', 'val' ) 
      SELECT 'dummy'
        , concat( 'aaa', '' )
    passed: true

  - id: 13
    subid: 1
    skip_from_test: true
    description: "All Rules Comprehensive Test"
    input:
      basic:
        exists: true
        value_match: "match"
        value_mismatch: "mismatch"
      sub:
        replace: "replaced_value"
        keep_line: "kept"
      pg:
        simple_key: "simple_val"
        array_str: ["a", "b", "c"]
        nested:
          deep_key: "deep_val"
          number: 42
      ops:
        email: "test@gmail.com"
        name: "John Doe"
        desc: "This is a long description text"
        status: "active"
      jsonpath:
        a: 10
        b: 20
        list:
          - id: 1
            active: true
          - id: 2
            active: false
      special_chars: "value_with_underscore"
      empty_str: ""
    text: |
      -- ============================================================
      -- MKS SQL Parser Comprehensive Test Case
      -- Covers all rules defined in config.yaml (IDs 1-12)
      -- Input: test/all_rules.json
      -- ============================================================

      SELECT 'START_TEST' as status;

      -- ============================================================
      -- GROUP 1: BLOCK LOGIC (IDs 1, 2, 3, 4, 5)
      -- ============================================================

      -- [ID 1] Standard Block Logic
      -- 1.1 Exists (Should be KEPT)
      --<basic.exists
      SELECT 'Block 1.1 KEPT' as rule_1_exists;
      -->

      -- 1.2 Not Exists (Should be KEPT)
      --<!basic.missing_key
      SELECT 'Block 1.2 KEPT' as rule_1_not_exists;
      -->

      -- 1.3 Value Match (Should be KEPT)
      --<basic.value_match:match
      SELECT 'Block 1.3 KEPT' as rule_1_value_match;
      -->

      -- 1.4 Value Mismatch (Should be REMOVED)
      --<basic.value_match:wrong_value
      SELECT 'Block 1.4 REMOVED' as rule_1_value_mismatch;
      -->

      -- [ID 2] JSONPath Block Logic
      -- 2.1 Complex Expression (Should be KEPT)
      --<{ $.jsonpath.a + $.jsonpath.b == 30 }
      SELECT 'Block 2.1 KEPT' as rule_2_jsonpath_math;
      -->

      -- 2.2 Array Check (Should be KEPT)
      --<{ $.jsonpath.list[0].active == true }
      SELECT 'Block 2.2 KEPT' as rule_2_jsonpath_array;
      -->

      -- 2.3 False Expression (Should be REMOVED)
      --<{ $.jsonpath.a > 100 }
      SELECT 'Block 2.3 REMOVED' as rule_2_jsonpath_false;
      -->

      -- [ID 4] Nested Block (Postgres Syntax)
      -- 4.1 Nested Exists (Should be KEPT)
      --< $1 #> '{pg,nested,deep_key}' >
      SELECT 'Block 4.1 KEPT' as rule_4_nested_exists;
      -->

      -- 4.2 Nested Value Match (Should be KEPT)
      --< $1 #> '{pg,nested,number}' = '42' >
      SELECT 'Block 4.2 KEPT' as rule_4_nested_value;
      -->

      -- [ID 5] Simple Extended Block Logic
      -- 5.1 Regex Match (Should be KEPT)
      --< #'ops.email' ~ '@gmail\.com$' >
      SELECT 'Block 5.1 KEPT' as rule_5_regex;
      -->

      -- 5.2 LIKE Match (Should be KEPT)
      --< #'ops.name' ~~ 'J%' >
      SELECT 'Block 5.2 KEPT' as rule_5_like;
      -->

      -- 5.3 Not Equal (Should be KEPT)
      --< #'ops.status' != 'inactive' >
      SELECT 'Block 5.3 KEPT' as rule_5_not_equal;
      -->

      -- ============================================================
      -- GROUP 2: LINE FILTERS (IDs 6, 7, 8, 10)
      -- ============================================================

      -- [ID 8] Standard Line Filters
      SELECT 'Line 8.1 KEPT' as rule_8_exists;      -- #basic.exists
      SELECT 'Line 8.2 REMOVED' as rule_8_exists_fail; -- #basic.missing
      SELECT 'Line 8.3 KEPT' as rule_8_not_exists;  -- #!basic.missing
      SELECT 'Line 8.4 KEPT' as rule_8_val_match;   -- #basic.value_match:match
      SELECT 'Line 8.5 REMOVED' as rule_8_val_fail;    -- #basic.value_match:wrong

      -- [ID 6] JSONPath Line Filters
      SELECT 'Line 6.1 KEPT' as rule_6_path_true;   -- #{ $.jsonpath.b > 10 }
      SELECT 'Line 6.2 REMOVED' as rule_6_path_false;  -- #{ $.jsonpath.b < 10 }

      -- [ID 7] Simple Extended Line Filters
      SELECT 'Line 7.1 KEPT' as rule_7_regex;       -- #'ops.email' ~ 'test'
      SELECT 'Line 7.2 REMOVED' as rule_7_regex_fail;  -- #'ops.email' !~ 'test'
      SELECT 'Line 7.3 KEPT' as rule_7_like;        -- #'ops.desc' ~~ '%long%'

      -- [ID 10] Nested Line Filters (Postgres Syntax)
      SELECT 'Line 10.1 KEPT' as rule_10_nest_ex;   -- $1 #> '{pg,nested,deep_key}'
      SELECT 'Line 10.2 KEPT' as rule_10_nest_val;  -- $1 #> '{pg,nested,number}' = '42'
      SELECT 'Line 10.3 REMOVED' as rule_10_val_fail;  -- $1 #> '{pg,nested,number}' = '99'

      -- ============================================================
      -- GROUP 3: POSTGRES FILTERS (ID 9)
      -- ============================================================

      -- 9.1 Simple Key Access (Result must not be null/missing)
      SELECT 1 FROM tmptbl WHERE id = $1->'pg'; -- Kept because 'pg' exists

      -- 9.2 Path Access
      SELECT 1 FROM tmptbl WHERE val = $1#>>'{pg,simple_key}'; -- Kept

      -- 9.3 Missing Key (Should be REMOVED)
      SELECT 1 FROM tmptbl WHERE id = $1->'non_existent_key'; -- REMOVED

      -- ============================================================
      -- GROUP 4: SUBSTITUTIONS (IDs 11, 12)
      -- ============================================================

      -- [ID 12] Replace or Empty (%key%)
      SELECT '%sub.replace%' as rule_12_replaced; -- Should be 'replaced_value'
      SELECT '%sub.missing%' as rule_12_empty;    -- Should be ''

      -- [ID 11] Replace or Delete (:key, $key)
      SELECT :sub.replace    as rule_11_colon_kept;   -- Should be replaced
      SELECT :sub.missing    as rule_11_colon_del;    -- Should be REMOVED
      SELECT $sub.replace    as rule_11_dollar_kept;  -- Should be replaced
      SELECT $sub.missing    as rule_11_dollar_del;   -- Should be REMOVED

      SELECT 'END_TEST' as status;
    expected: ""
    passed: false
