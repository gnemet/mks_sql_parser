<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MKS SQL Parser Tester</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js -->
    <link rel="stylesheet" id="hljs-theme"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <link rel="stylesheet" href="style.css">
</head>

<body class="light-mode">
    <header>
        <div class="header-left">
            <h1><i class="fas fa-database"></i> MKS SQL Parser Tester</h1>
        </div>
        <div class="header-center">
            <select id="test-chooser" name="testId" onchange="loadTest(this.value)">
                <option value="">Select a Test Case...</option>
                <!-- Options populated by JS -->
            </select>
        </div>
        <div class="header-right">
            <button id="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
                <i class="fas fa-moon"></i>
            </button>
            <button id="doc-toggle" onclick="toggleDoc()" title="Show Reference Guide">
                <i class="fas fa-book"></i>
            </button>
            <button id="help-toggle" onclick="toggleHelp()" title="How to use">
                <i class="fas fa-question-circle"></i>
            </button>
        </div>
    </header>

    <main class="container" id="main-container">
        <div class="left-column" id="left-col">
            <div class="editor-pane sql-pane" id="pane-sql">
                <div class="pane-header">
                    <label>
                        <button class="icon-btn fold-btn" onclick="toggleFold('pane-sql')" title="Minimize"><i
                                class="fas fa-minus"></i></button>
                        <i class="fas fa-code"></i> SQL Text
                    </label>
                    <div class="pane-actions">
                        <input type="file" id="upload-sql" accept=".sql,.txt" style="display:none"
                            onchange="loadFile(this, 'sql-text')">
                        <button class="icon-btn" onclick="document.getElementById('upload-sql').click()"
                            title="Upload File">
                            <i class="fas fa-upload"></i>
                        </button>
                        <button class="icon-btn" onclick="copyToClipboard('sql-text')" title="Copy to Clipboard">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                <textarea id="sql-text" name="sql" spellcheck="false"
                    placeholder="Enter SQL here or drag & drop a file..."></textarea>
            </div>

            <div class="gutter gutter-horizontal" id="gutter-h"></div>

            <div class="editor-pane json-pane" id="pane-json">
                <div class="pane-header">
                    <label>
                        <button class="icon-btn fold-btn" onclick="toggleFold('pane-json')" title="Minimize"><i
                                class="fas fa-minus"></i></button>
                        <i class="fas fa-file-code"></i> Input JSON
                    </label>
                    <div class="pane-actions">
                        <input type="file" id="upload-json" accept=".json,.txt" style="display:none"
                            onchange="loadFile(this, 'json-input')">
                        <button class="icon-btn" onclick="document.getElementById('upload-json').click()"
                            title="Upload File">
                            <i class="fas fa-upload"></i>
                        </button>
                        <button class="icon-btn" onclick="copyToClipboard('json-input')" title="Copy to Clipboard">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                <textarea id="json-input" name="input" spellcheck="false" placeholder='{"key": "value"}'
                    oninput="validateJSON()"></textarea>
            </div>
        </div>

        <div class="gutter gutter-vertical" id="gutter-v"></div>

        <div class="editor-pane result-pane" id="pane-result">
            <div class="pane-header">
                <label>
                    <button class="icon-btn fold-btn" onclick="toggleFold('pane-result')" title="Minimize"><i
                            class="fas fa-minus"></i></button>
                    <i class="fas fa-terminal"></i> Result
                </label>
                <div class="pane-actions">
                    <button class="icon-btn" id="minify-btn" onclick="toggleMinify()"
                        title="Toggle Minified Output (Strip Comments)">
                        <i class="fas fa-compress-arrows-alt"></i>
                    </button>
                    <button class="icon-btn" onclick="downloadResult()" title="Save Result">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="icon-btn" onclick="copyToClipboard('result-output')" title="Copy to Clipboard">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button class="run-btn" onclick="runProcess()">
                        <i class="fas fa-play"></i> Run
                    </button>
                </div>
            </div>
            <div id="result-output" class="output-area"></div>
        </div>
    </main>

    <div id="doc-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="toggleDoc()">&times;</span>
            <h2>Reference Guide</h2>
            <div id="doc-content" class="markdown-body">
                Loading documentation...
            </div>
        </div>
    </div>

    <div id="help-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="toggleHelp()">&times;</span>
            <h2>How to use the Tester</h2>
            <div class="markdown-body">
                <ol>
                    <li><strong>Select a Test Case</strong>: Use the dropdown in the header to load pre-configured
                        examples. This populates both SQL and JSON Editors.</li>
                    <li><strong>Edit Code</strong>:
                        <ul>
                            <li><strong>SQL Text</strong>: Write your SQL query with MKS Parser syntax (e.g.,
                                <code>--&lt;condition</code> blocks).
                            </li>
                            <li><strong>Input JSON</strong>: Define the variables/context for the parser.</li>
                        </ul>
                    </li>
                    <li><strong>Run Parser</strong>: Click the <strong><i class="fas fa-play"></i> Run</strong> button
                        (or valid Test Case load) to process the SQL.</li>
                    <li><strong>View Results</strong>: The <strong>Result</strong> pane shows the final SQL after
                        processing.</li>
                </ol>
                <h3>Features</h3>
                <ul>
                    <li><strong>Drag & Drop</strong>: Drag <code>.sql</code> or <code>.json</code> files directly into
                        the editors.</li>
                    <li><strong>Upload/Download</strong>: Use the <i class="fas fa-upload"></i> buttons to load files
                        and <i class="fas fa-download"></i> to save the result.</li>
                    <li><strong>Auto-Validation</strong>: The JSON editor warns you if your JSON is invalid.</li>
                    <li><strong>Docs</strong>: Click the <i class="fas fa-book"></i> icon for the full syntax reference.
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- About Footer -->
    <footer class="app-footer">
        <div class="footer-content">
            <span>&copy; <span id="year"></span> Gabor Nemet</span>
            <span class="separator">|</span>
            <span>Version: <span id="app-version">Loading...</span></span>
            <span class="separator">|</span>
            <a href="https://github.com/gnemet/mks_sql_parser" target="_blank" title="View Source on GitHub">
                <i class="fab fa-github"></i> GitHub
            </a>
        </div>
    </footer>

    <script src="wasm_exec.js"></script>
    <script src="mks_sql_ins_parser.js"></script>
    <script>

        // Use Wasm if not running on localhost:8080 (or if explicitly enabled, but for GitHub Pages we assume Wasm)
        // Or better: try to fetch /process, if fails, use Wasm. 
        // Actually, for GitHub Pages migration, we can just default to Wasm if the file exists or just always try to load it.
        // Let's implement a Wasm loader.

        const go = new Go();
        let wasmReady = false;

        // Try to load Wasm
        // Try to load Wasm
        WebAssembly.instantiateStreaming(fetch("mks.wasm?v=" + new Date().getTime()), go.importObject).then((result) => {
            go.run(result.instance);
            console.log("Wasm loaded");
            wasmReady = true;
            // Provide data from Wasm to frontend
            initializeDataFromWasm();
        }).catch((err) => {
            console.log("Wasm not loaded (maybe running on Go server):", err);
            // Fallback to fetch API if Wasm fails (e.g. running on local server without wasm build)
            initializeDataFromFetch();
        });

        // Configure Marked
        marked.setOptions({
            highlight: function (code, lang) {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language }).value;
            },
            langPrefix: 'hljs language-'
        });

        function initializeDataFromWasm() {
            // Wasm functions: getPatterns(), getTests() return JSON strings
            if (typeof getPatterns !== 'function') {
                setTimeout(initializeDataFromWasm, 100);
                return;
            }

            try {
                const patterns = JSON.parse(getPatterns());
                const tests = JSON.parse(getTests());
                // Version might be string or need parsing? It's just a string.
                if (typeof getVersion === 'function') {
                    document.getElementById('app-version').textContent = getVersion();
                }
                setupUI(tests, patterns);
            } catch (e) {
                console.error("Error loading data from Wasm:", e);
            }
        }

        function initializeDataFromFetch() {
            Promise.all([
                fetch('/tests').then(r => r.json()),
                fetch('/patterns').then(r => r.json()),
                fetch('/version').then(r => r.json())
            ]).then(([tests, patterns, verInfo]) => {
                if (verInfo && verInfo.version) {
                    const verEl = document.getElementById('app-version');
                    verEl.textContent = "Version: " + verInfo.version;
                    if (verInfo.last_build) {
                        verEl.title = "Built: " + verInfo.last_build;
                        verEl.style.cursor = "help";
                    }
                } else {
                    document.getElementById('app-version').textContent = "1.0.0 (Server)";
                }
                setupUI(tests, patterns);
            }).catch(e => console.error("Fetch failed:", e));
        }

        // Set Year
        document.getElementById('year').textContent = new Date().getFullYear();

        function setupUI(tests, patterns) {
            const select = document.getElementById('test-chooser');
            window.tests = tests; // Store globally
            window.patterns = patterns; // Store globally

            // Create Pattern Lookup Map
            const patternMap = {};
            patterns.forEach(p => {
                patternMap[p.id] = p.description;
            });

            // Sort tests by ID ascending
            tests.sort((a, b) => a.id - b.id);

            // Clear options first
            select.innerHTML = '<option value="">Select a Test Case...</option>';

            tests.forEach((test, index) => {
                const opt = document.createElement('option');
                opt.value = index;

                let desc = "Unknown Pattern";
                if (test.description && test.description.length > 0) {
                    desc = test.description;
                } else if (patternMap[test.id]) {
                    desc = patternMap[test.id];
                }

                if (desc.length > 120) desc = desc.substring(0, 117) + "...";

                opt.textContent = `${test.id} - ${desc}`;
                select.appendChild(opt);
            });
        }

        // Load Doc
        // On GitHub Pages, we are likely at /mks_sql_parser/
        // file is at /mks_sql_parser/doc/reference_guide.md if copied?
        // Wait, the deploy action only copies 'mks_so/cmd/server/static'.
        // Does 'static' contain 'doc'? No.
        // We need to copy 'doc' folder to 'static' in the build script!

        const docUrl = wasmReady || window.location.hostname.includes("github.io")
            ? "reference_guide.md" // We will put it in root of static
            : "/doc";

        // We'll try /doc first, if 404, try doc/reference_guide.md? 
        // Actually, let's just try fetching one then the other or depend on mode.
        // Simple heuristic:
        fetch(docUrl).then(r => {
            if (!r.ok) return fetch("doc/reference_guide.md");
            return r;
        })
            .then(r => r.text())
            .then(text => {
                const html = marked.parse(text);
                const docContent = document.getElementById('doc-content');
                docContent.innerHTML = html;
                docContent.style.whiteSpace = 'normal';
                docContent.style.fontFamily = 'inherit';
            });


        // Initial Theme Check
        updateHighlightTheme();

        // document.addEventListener('DOMContentLoaded', () => { ... }); // Removed, we call init above

        function getTestDescription(test) {
            return `Test Case ${test.id}`;
        }

        function loadTest(index) {
            if (index === "" || index === null) return;
            const test = window.tests[index];
            if (test) {
                document.getElementById('sql-text').value = test.text;
                document.getElementById('json-input').value = JSON.stringify(test.input, null, 2);
                document.getElementById('result-output').textContent = "";
            }
        }

        async function runProcess() {
            const sql = document.getElementById('sql-text').value;
            const input = document.getElementById('json-input').value;
            const outputDiv = document.getElementById('result-output');
            const minify = document.getElementById('minify-btn').classList.contains('active');

            outputDiv.textContent = "Processing...";
            outputDiv.className = "output-area";

            if (wasmReady && typeof processSql === 'function') {
                try {
                    // Wasm execution
                    // processSql returns string result directly
                    const result = processSql(sql, input, minify);
                    outputDiv.textContent = result;
                } catch (e) {
                    outputDiv.textContent = "Wasm Error: " + e;
                    outputDiv.classList.add("error-text");
                }
            } else {
                // Server fallback
                try {
                    const response = await fetch('/process', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sql, input, minify })
                    });

                    const data = await response.json();
                    if (data.error) {
                        outputDiv.textContent = "Error: " + data.error;
                        outputDiv.classList.add("error-text");
                    } else {
                        outputDiv.textContent = data.result;
                    }
                } catch (e) {
                    outputDiv.textContent = "Network Error: " + e.message;
                    outputDiv.classList.add("error-text");
                }
            }
        }

        function toggleMinify() {
            const btn = document.getElementById('minify-btn');
            btn.classList.toggle('active');
        }

        // Initial Theme Check
        // Check system preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.replace('light-mode', 'dark-mode');
            document.querySelector('#theme-toggle i').classList.replace('fa-moon', 'fa-sun');
        }
        updateHighlightTheme();

        // Listen for system changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            const body = document.body;
            const icon = document.querySelector('#theme-toggle i');
            // Only update if user hasn't toggled manually? 
            // For simplicity, let system override or just sync.
            // Let's just sync to system change.
            if (event.matches) {
                if (body.classList.contains('light-mode')) {
                    body.classList.replace('light-mode', 'dark-mode');
                    icon.classList.replace('fa-moon', 'fa-sun');
                }
            } else {
                if (body.classList.contains('dark-mode')) {
                    body.classList.replace('dark-mode', 'light-mode');
                    icon.classList.replace('fa-sun', 'fa-moon');
                }
            }
            updateHighlightTheme();
        });

        function toggleTheme() {
            const body = document.body;
            const icon = document.querySelector('#theme-toggle i');
            if (body.classList.contains('light-mode')) {
                body.classList.replace('light-mode', 'dark-mode');
                icon.classList.replace('fa-moon', 'fa-sun');
            } else {
                body.classList.replace('dark-mode', 'light-mode');
                icon.classList.replace('fa-sun', 'fa-moon');
            }
            updateHighlightTheme();
        }

        function updateHighlightTheme() {
            const isDark = document.body.classList.contains('dark-mode');
            const themeLink = document.getElementById('hljs-theme');
            if (isDark) {
                themeLink.href = "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css";
            } else {
                themeLink.href = "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css";
            }
        }

        function toggleDoc() {
            const modal = document.getElementById('doc-modal');
            modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
        }

        function toggleHelp() {
            const modal = document.getElementById('help-modal');
            modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
        }

        window.onclick = function (event) {
            const docModal = document.getElementById('doc-modal');
            const helpModal = document.getElementById('help-modal');
            if (event.target == docModal) {
                docModal.style.display = "none";
            }
            if (event.target == helpModal) {
                helpModal.style.display = "none";
            }
        }

        /* --- New UX Features --- */

        // 1. File Upload & Drag-n-Drop
        function setupDragDrop(elementId) {
            const dropZone = document.getElementById(elementId);
            if (!dropZone) return;

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });

            function highlight(e) {
                dropZone.classList.add('drag-over');
            }

            function unhighlight(e) {
                dropZone.classList.remove('drag-over');
            }

            dropZone.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length > 0) {
                    processFile(files[0], elementId);
                }
            }
        }

        // Initialize Drag & Drop
        setupDragDrop('sql-text');
        setupDragDrop('json-input');

        function loadFile(input, targetId) {
            if (input.files && input.files[0]) {
                processFile(input.files[0], targetId);
                // Reset input so same file can be selected again if needed
                input.value = '';
            }
        }

        function processFile(file, targetId) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const text = e.target.result;

                // Check if file is mks_sql_ins wrapper
                if (text.includes("select mks_sql_ins(")) {
                    if (typeof MksSqlInsParser !== 'undefined') {
                        const parser = new MksSqlInsParser();
                        const parsed = parser.parse(text);
                        if (parsed) {
                            if (parsed.sql) {
                                document.getElementById('sql-text').value = parsed.sql;
                            }
                            if (parsed.info && parsed.info.default !== undefined) {
                                let val = parsed.info.default;
                                if (typeof val === 'object') {
                                    document.getElementById('json-input').value = JSON.stringify(val, null, 2);
                                } else {
                                    document.getElementById('json-input').value = val;
                                }
                                validateJSON();
                            }
                            return;
                        }
                    } else {
                        console.warn("MksSqlInsParser not loaded");
                    }
                }

                const target = document.getElementById(targetId);
                target.value = text;

                // If JSON input, trigger validation
                if (targetId === 'json-input') {
                    validateJSON();
                }
            };
            reader.readAsText(file);
        }

        // --- MKS SQL Parser Helpers ---

        function parseMksSqlIns(content) {
            const startIdx = content.indexOf('select mks_sql_ins(');
            if (startIdx === -1) return null;

            let idx = startIdx + 'select mks_sql_ins('.length;
            let balance = 1;
            let args = [];
            let currentArg = '';
            let inQuote = false;
            let quoteChar = '';
            let inDollarQuote = false;
            let dollarTag = '';

            for (; idx < content.length; idx++) {
                const char = content[idx];

                if (inDollarQuote) {
                    currentArg += char;
                    if (char === '$') {
                        if (currentArg.endsWith(dollarTag)) {
                            inDollarQuote = false;
                        }
                    }
                    continue;
                }

                if (inQuote) {
                    currentArg += char;
                    if (char === quoteChar) {
                        inQuote = false;
                    }
                    continue;
                }

                if (char === '$') {
                    const tagMatch = content.substring(idx).match(/^(\$[a-zA-Z0-9_]*\$)/);
                    if (tagMatch) {
                        inDollarQuote = true;
                        dollarTag = tagMatch[1];
                        currentArg += char;
                        continue;
                    }
                }

                if (char === "'") {
                    inQuote = true;
                    quoteChar = "'";
                    currentArg += char;
                    continue;
                }

                if (char === '(') {
                    balance++;
                    currentArg += char;
                    continue;
                }

                if (char === ')') {
                    balance--;
                    if (balance === 0) {
                        args.push(currentArg.trim());
                        break;
                    }
                    currentArg += char;
                    continue;
                }

                if (char === ',' && balance === 1) {
                    args.push(currentArg.trim());
                    currentArg = '';
                    continue;
                }

                currentArg += char;
            }

            if (args.length < 2) return null;

            return {
                info_raw: args[0],
                sql_raw: args[1],
                unit_test_raw: args[2],
                data_raw: args[3]
            };
        }

        function parseSqlInfo(raw) {
            // Check for json_build_object
            const match = raw.match(/^\s*json_build_object\s*\(([\s\S]*)\)\s*$/);
            if (!match) return null;

            const inner = match[1];
            const result = {};
            let parts = [];

            let buffer = '';
            let pBalance = 0;
            let pInQuote = false;
            let pQuoteChar = '';
            let pInDollar = false;
            let pDollarTag = '';

            for (let i = 0; i < inner.length; i++) {
                const c = inner[i];
                if (pInDollar) {
                    buffer += c;
                    if (c === '$' && buffer.endsWith(pDollarTag)) pInDollar = false;
                    continue;
                }
                if (pInQuote) {
                    buffer += c;
                    if (c === pQuoteChar) pInQuote = false;
                    continue;
                }
                if (c === '$') {
                    const tm = inner.substring(i).match(/^(\$[a-zA-Z0-9_]*\$)/);
                    if (tm) { pInDollar = true; pDollarTag = tm[1]; }
                }
                if (c === "'") { pInQuote = true; pQuoteChar = "'"; }
                if (c === '(') pBalance++;
                if (c === ')') pBalance--;

                if (c === ',' && pBalance === 0) {
                    parts.push(buffer.trim());
                    buffer = '';
                } else {
                    buffer += c;
                }
            }
            if (buffer.trim()) parts.push(buffer.trim());

            for (let i = 0; i < parts.length; i += 2) {
                let key = parts[i];
                let val = parts[i + 1];

                if (!key) continue;
                key = key.replace(/^'|'$/g, '');

                if (!val) continue;

                if (val.startsWith("'") && val.endsWith("'")) {
                    val = val.substring(1, val.length - 1);
                } else if (val.startsWith("'{") && val.endsWith("}'::text[]")) {
                    const content = val.match(/^'\{(.*?)\}'::text\[\]$/)[1];
                    val = content.split(',').map(s => s.trim().replace(/"/g, ''));
                } else if (val.startsWith("$json$")) {
                    const endTag = "$json$";
                    const startIdx = endTag.length;
                    const endIdx = val.indexOf(endTag, startIdx);
                    if (endIdx !== -1) {
                        const jContent = val.substring(startIdx, endIdx);
                        try {
                            val = JSON.parse(jContent);
                        } catch (e) { val = jContent; }
                    }
                } else if (/^jsonb\s*'.*'$/.test(val)) {
                    // Handle jsonb '{}'
                    const m = val.match(/^jsonb\s*'(.*)'$/);
                    if (m) {
                        try {
                            val = JSON.parse(m[1].replace(/''/g, "'"));
                        } catch (e) { val = m[1]; }
                    }
                } else if (/^'.*'::jsonb$/.test(val)) {
                    // Handle '{}'::jsonb
                    const m = val.match(/^'(.*)'::jsonb$/);
                    if (m) {
                        try {
                            val = JSON.parse(m[1].replace(/''/g, "'"));
                        } catch (e) { val = m[1]; }
                    }
                }

                if (typeof val === 'string' && val.includes("current_timestamp")) {
                    val = "CURRENT_TIMESTAMP";
                }

                result[key] = val;
            }
            return result;
        }

        function cleanSql(raw) {
            const m = raw.match(/^\$([a-zA-Z0-9_]*)\$([\s\S]*)\$\1\$/);
            if (m) return m[2].trim();
            // Handle single quotes
            if (raw.startsWith("'") && raw.endsWith("'")) {
                let s = raw.substring(1, raw.length - 1);
                s = s.replace(/''/g, "'"); // unescape
                return s;
            }
            return raw;
        }

        // 2. JSON Validation
        function validateJSON() {
            const input = document.getElementById('json-input');
            const val = input.value.trim();
            if (!val) {
                input.classList.remove('invalid-json');
                return;
            }
            try {
                JSON.parse(val);
                input.classList.remove('invalid-json');
            } catch (e) {
                input.classList.add('invalid-json');
            }
        }

        // 3. Copy to Clipboard
        function copyToClipboard(elementId) {
            let text = "";
            const el = document.getElementById(elementId);

            if (el.tagName === 'TEXTAREA' || el.tagName === 'INPUT') {
                text = el.value;
            } else {
                text = el.innerText; // For div/output
            }

            navigator.clipboard.writeText(text).then(() => {
                // Determine button to give feedback
                // Find button related to this action? 
                // We typically call this from an onclick, but passed ID. 
                // It's hard to find the *exact* button instance easily without passing 'this'. 
                // For now, simpler implementation: just log or simple visual cue if possible.
                // Or we can find button via selector near the element header?
                // Let's keep it simple: maybe show a global Toast? Or just assume it works.
                console.log("Copied to clipboard");
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }

        // 4. Download Result
        function downloadResult() {
            const content = document.getElementById('result-output').innerText;
            if (!content) return;

            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'result.txt'; // or .sql
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        }

        /* --- Resizable & Foldable Core --- */

        // Splitter Logic
        const makeResizable = function (resizerId, prevSiblingId, direction) {
            const resizer = document.getElementById(resizerId);
            const prevSibling = document.getElementById(prevSiblingId);

            if (!resizer || !prevSibling) return;

            let x = 0;
            let y = 0;
            let prevSize = 0;

            const mouseDownHandler = function (e) {
                x = e.clientX;
                y = e.clientY;
                const rect = prevSibling.getBoundingClientRect();
                prevSize = (direction === 'horizontal') ? rect.height : rect.width;

                document.addEventListener('mousemove', mouseMoveHandler);
                document.addEventListener('mouseup', mouseUpHandler);
                document.body.style.cursor = (direction === 'horizontal') ? 'row-resize' : 'col-resize';
                resizer.style.backgroundColor = 'var(--accent-color)'; // Active feedback
            };

            const mouseMoveHandler = function (e) {
                const dx = e.clientX - x;
                const dy = e.clientY - y;

                if (direction === 'horizontal') {
                    const newHeight = prevSize + dy;
                    if (newHeight > 30) { // Min height
                        prevSibling.style.flex = `0 0 ${newHeight}px`;
                        // Also reset sibling? Flexbox should handle remaining space if other is flex:1
                    }
                } else {
                    const newWidth = prevSize + dx;
                    if (newWidth > 150) { // Min width
                        prevSibling.style.flex = `0 0 ${newWidth}px`;
                    }
                }
            };

            const mouseUpHandler = function () {
                document.body.style.cursor = '';
                resizer.style.backgroundColor = '';
                document.removeEventListener('mousemove', mouseMoveHandler);
                document.removeEventListener('mouseup', mouseUpHandler);
            };

            resizer.addEventListener('mousedown', mouseDownHandler);
        };

        // Initialize Splitters
        makeResizable('gutter-h', 'pane-sql', 'horizontal');
        makeResizable('gutter-v', 'left-col', 'vertical');

        // Fold Logic
        function toggleFold(paneId) {
            const pane = document.getElementById(paneId);
            const btn = pane.querySelector('.fold-btn i');

            pane.classList.toggle('collapsed');

            if (pane.classList.contains('collapsed')) {
                btn.classList.replace('fa-minus', 'fa-plus');
                // Optional: Store size before collapse?
            } else {
                btn.classList.replace('fa-plus', 'fa-minus');
            }
        }
    </script>
</body>

</html>